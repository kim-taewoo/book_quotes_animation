<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1">
    <title></title>
    <link rel="stylesheet" href="./style3.css">
    <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js" charset="utf-8"></script>
    <style>

      *, *:before, *:after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      html,body {
        height: 100%;
        background-color: #eee;
        overflow-x: hidden;
        font-size: 62.5%;
      }

      .container {
        width: 100%;
        height: 100%;
      }

      .cards {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 35rem;
        height: 51rem;
        /* width: 45rem;
        height: 66rem; */
        border-radius: 10px;
        box-shadow: 0.5rem 1rem 3rem rgba(0, 0, 0, 0.7);
      }

      .card {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 60%;
        border-radius: 10px 10px 4px 4px;
        display: none;
        padding: 1.5rem;
        /* overflow-y: hidden; */
      }

      .card p {
        position: relative;
        width: 95%;
        height: 95%;
        margin: auto;
        vertical-align: middle;
        font-size: 2rem;
        overflow: hidden;
      }

      .current{
        display: block;
        z-index: 5;
      }

      .next{
        display: block;
      }

      .description {
        position: absolute;
        top: 38rem;
        margin: auto 4.2rem;
        width: 26.6rem;
      }
      .description__line {
        position: absolute;
        top: 3.5rem;
        width: 100%;
        border-bottom: 1px solid #ccc;
      }
      .description__title, .description__text {
        position: absolute;
        will-change: transform, opacity;
        transform: translateZ(0);
        opacity: 1;
        transition: all 0.25s cubic-bezier(0.74, 0.05, 0.94, 0.36);
      }
      .description__title {
        width: 100%;
        font-size: 2rem;
        font-weight: 600;
      }
      .description__text {
        top: 5rem;
        font-size: 1.7rem;
        font-weight: 300;
        color: #aaa;
        transition-delay: 0.03s;
      }
      .description__text.hide {
        transition-delay: 0.28s;
      }
      .fadeout-up {
        opacity: 0;
        transform: translate3D(0, -2rem, 0);
      }
      .hide {
        opacity: 0;
        transform: translate3D(0, 2rem, 0);
        transition: all 0.25s cubic-bezier(0.05, 0.67, 0.47, 0.99);
        transition-delay: 0.25s;
      }
      .fadein-up {
        opacity: 1;
        transform: translate3D(0, 0, 0);
      }


    </style>
  </head>
  <body>
    <div id="app">
      <div class="container">
        <div class="cards">
          <div class="card div1" style="background-color:skyblue">
            <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidat
            </p>
          </div>
          <div class="card div2" style="background-color:pink">

          </div>
          <div class="card div3" style="background-color:yellow">

          </div>
          <div class="card div4" style="background-color:gray">
            <!-- <div class="wrapper">
              <div class="description">
                <div class="first-row">
                  <div class="title">

                  </div>
                  <ul>
                    <li>참여 수</li>
                    <li>팔로우 수</li>
                    <li>댓글</li>
                  </ul>
                </div>
                <div class="second-row">
                  <p>작가의 말</p>
                </div>
              </div>
              <div class="preview">

              </div>
            </div> -->
          </div>

          <div class="description">
            <div class="description__title"><span>안나 카레리나</span></div>
            <div class="description__title hide"><span>노인과 바다</span></div>
            <div class="description__title hide"><span>La Crusc, Italy</span></div>
            <div class="description__title hide"><span>La Crusc, Italy</span></div>
            <div class="description__line"></div>
            <div class="description__text"><span>How about you explore cultural events in La Crusc?</span></div>
            <div class="description__text hide"><span>두번째 문구</span></div>
            <div class="description__text hide"><span>안녕하세요</span></div>
            <div class="description__text hide"><span>More demos soon =)</span></div>
          </div>
      </div>

    </div>

    <script>
    window.onload = function(){
      const cards = [].slice.call(document.querySelectorAll('.card'));
      const titles = [].slice.call(document.querySelectorAll(".description__title"));
      const texts = [].slice.call(document.querySelectorAll(".description__text"));


      var fromTo = (from, to, prgrs = 0) => from + (to - from) * prgrs;

      var easing = {
        inCubic: function(t, b, c, d) { // t: current time, b: begInnIng value, c: change In value, d: duration
          var ts = (t /= d) * t;
          var tc = ts * t;
          return b + c * (1.7 * tc * ts - 2.05 * ts * ts + 1.5 * tc - 0.2 * ts + 0.05 * t);
        }
      };

      var transforms = {
        translate3D: function(x = 0, y = 0, z = 0, el = "px") {
          return `translate3d(${x}${el}, ${y}${el}, ${z}${el})`;
        },

        rotate3d: function(x = 0, y = 0, z = 0, deg = 0) {
          return `rotate3d(${x}, ${y}, ${z}, ${deg}deg)`;
        },

        rotate: function(deg = 0) {
          return `rotate(${deg}deg)`;
        },

        scale: function(x = 0, y = 0) {
          return `scale(${x}, ${y})`;
        },

        perspective: function(val = 0, el = "px") {
          return `perspective(${val}${el})`;
        }
      };

      var descriptions = {
        index: 0,
        timeout: 550,
        titles: titles.slice(),
        texts: texts.slice(),

        animateDescription: function() {
          this.titles[0].classList.add("fadeout-up");
          this.titles[1].classList.add("fadein-up");
          this.texts[0].classList.add("fadeout-up");
          this.texts[1].classList.add("fadein-up");
        },

        swapDescription: function() {
          let shdC = this.titles.shift();
          let shdT = this.texts.shift();

          let count = titles.length;
          if (count > this.index + 4) {
            this.titles.push(countries[this.index + 5]);
            this.texts.push(texts[this.index + 5]);
          }
          else {
            this.titles.push(shdC);
            this.texts.push(shdT);
          }
          this.index === count ? this.index = 0 : this.index++;
          this.initDescriptions();
        },

        initDescriptions: function () {
          let length = this.titles.length;
          this.titles[0].classList.remove("hide", "fadein-up");
          this.titles[length - 1].classList.add("hide")
          this.titles[length - 1].classList.remove("fadeout-up");
          this.texts[0].classList.remove("hide", "fadein-up");
          this.texts[length - 1].classList.add("hide")
          this.texts[length - 1].classList.remove("fadeout-up");
        }
      };


      var curBlocks = {
        blocks: cards.slice(),
        index: 0,

        swapBlocks: function() {
          let shd = this.blocks.shift();
          let count = cards.length;
          if (count > this.index +4) {
            this.blocks.push(cards[this.index +5]);
          }
          else {
            this.blocks.push(shd);
          }
          shd.classList.remove('current');
          this.index === count ? this.index = 0 : this.index++;
          initScene();
        }
      };

      var block = {
        width: 35,
        heigth: 30.6,
        b2scale: 32 / 35,
        upHeigth: 1,

        b2caclH: 0,

        interact: false
      };

      var initScene = function() {
        block.b2caclH =
        block.heigth * (1 - block.b2scale) * (1 / block.b2scale) / 2
        + block.upHeigth * (1 / block.b2scale);

        curBlocks.blocks[0].style.transform = transforms.translate3D(0, 0, 0, "rem");
        curBlocks.blocks[1].style.transform =
        transforms.scale(block.b2scale, block.b2scale)
        + transforms.translate3D(0, block.b2caclH, 0, "rem");

        curBlocks.blocks[0].style.opacity = 1;
        curBlocks.blocks[1].style.opacity = 0.1;

        curBlocks.blocks[0].className = "card current";
        curBlocks.blocks[1].className = "card next";
        // bindDrag();
      };

      initScene();

      var drag = {
        degree: 2.4,
        upHeight: 1.7,
        maxDrag: 78,
        b2scale: 0.98,
        dx: 0,
        frameBusy: false,
        helloSafari: 2.8 // need to add this coz of strange behavior
      };


      var dragBlock = function() {
        const maxStep = drag.maxDrag;
        let curStep = drag.dx;
        if (curStep > maxStep) curStep = maxStep;
        if (curStep < -maxStep) curStep = -maxStep;

        let progress = curStep / maxStep;
        let curDeg = drag.degree * progress;
        let curUpLen = drag.upHeight * Math.abs(curStep) / maxStep;
        let curScaleBlock2 = drag.b2scale + (1 - drag.b2scale) * (maxStep - curStep) / maxStep;

        curBlocks.blocks[0].style.transform =
            transforms.perspective(220, "rem")
          + transforms.rotate(curDeg)
          + transforms.rotate3d(1, 1, 0, curDeg * 3)
          + transforms.translate3D(0, -curUpLen, 0, "rem");

        curBlocks.blocks[1].style.transform =
            transforms.scale(block.b2scale * curScaleBlock2, block.b2scale * curScaleBlock2)
          + transforms.translate3D(0, block.b2caclH - curUpLen / 4, 0, "rem")
          + transforms.rotate(curDeg / 3)
          + transforms.rotate3d(1, 1, 0, curDeg * drag.helloSafari);

        curBlocks.blocks[0].style.opacity = 1;
        curBlocks.blocks[1].style.opacity = fromTo(0.1, 0.7, progress);
        drag.frameBusy = false;
      };

      var throwing = {
        animating: false,
        curStep: 0,
        maxStep: 15
      };

      var throwBlock = function() {
        if (++throwing.curStep > throwing.maxStep) {
          // hammer.off("mousedown touchstart");
          throwing.curStep = 0;
          drag.dx = 0;
          curBlocks.swapBlocks();
          return;
        }
        //
        let progress = easing.inCubic(throwing.curStep, 0, 1, throwing.maxStep);
        let delta = easing.inCubic(throwing.curStep, 0, 1, throwing.maxStep) * 40;

        curBlocks.blocks[0].style.transform =
            transforms.rotate(drag.degree + delta / 2)
          + transforms.rotate3d(1, 1, 0, drag.degree * 3)
          + transforms.translate3D(delta, -drag.upHeight - delta / 1.2, 0, "rem");

        let b2Scale = fromTo(block.b2scale * drag.b2scale, 1, progress);
        let b2TransY = fromTo(block.b2caclH - drag.upHeight / 4, 0, progress);
        let b2Rot = fromTo(drag.degree / 3, 0, progress);

        curBlocks.blocks[1].style.transform =
            transforms.scale(b2Scale, b2Scale)
          + transforms.translate3D(0, b2TransY, 0, "rem")
          + transforms.rotate(b2Rot)
          + transforms.rotate3d(1, 1, 0, drag.degree * drag.helloSafari);

        curBlocks.blocks[0].style.opacity = fromTo(1, 0.5, progress);
        curBlocks.blocks[1].style.opacity = fromTo(0.7, 1, progress);

        requestAnimationFrame(throwBlock);
      };

      // function bindDrag() {
      var touchZone = document.querySelector('.cards')
      var hammer = new Hammer.Manager(touchZone);
      hammer.add(new Hammer.Pan({direction: Hammer.DIRECTION_ALL, threshold: 5}));
      hammer.on('pan', function(e){
        if (e.deltaX <= 0) e.deltaX = 0;
        if (e.deltaY >= 0) e.deltaY = 0;
        block.interact = true;
        drag.dx = Math.sqrt(Math.pow(e.deltaX, 2) + Math.pow(e.deltaY, 2));
        if (!drag.dx) return;
        if (drag.frameBusy) return;
        drag.frameBusy = true;
        requestAnimationFrame(dragBlock);
      })
      hammer.on("panend", function (e) {
        if (Math.abs(drag.dx) < drag.maxDrag) {
          drag.dx = 0;
          requestAnimationFrame(dragBlock);
        }
        else {
          descriptions.animateDescription();
          setTimeout(descriptions.swapDescription.bind(descriptions), descriptions.timeout);
          requestAnimationFrame(throwBlock);
        }
      })


      function prevAnimation() {
        let initDel = 500;
        let frames = drag.maxDrag;
        let spd = 15;
        for (let i = 1; i < frames; i++) {
          setTimeout(() => {
            if (!block.interact) {
              drag.dx = i;
              if (drag.frameBusy) return;
              requestAnimationFrame(dragBlock);
            }
          }, initDel + spd * i);
        }
        for (let i = frames; i >= 0; i--) {
          setTimeout(() => {
            if (!block.interact) {
              drag.dx = i;
              if (drag.frameBusy) return;
              requestAnimationFrame(dragBlock);
            }
          }, initDel + spd * (frames * 2 + 1 - i));
        }
      }
      prevAnimation()
    }()

    </script>

  </body>
</html>
