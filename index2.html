<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <!-- <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1"> -->
    <title></title>
    <link rel="stylesheet" href="./style3.css">
    <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.1/hammer.min.js" charset="utf-8"></script>
    <style>

      *, *:before, *:after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      html,body {
        height: 100%;
        background-color: #eee;
        overflow-x: hidden;
      }

      .container {
        width: 100%;
        height: 100%;
      }

      .cards {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 35rem;
        height: 51rem;
        border-radius: 3px;
        box-shadow: 0.5rem 1rem 3rem rgba(0, 0, 0, 0.7);
      }

      .card {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 60%;
        display: none;
        overflow-y: hidden;
      }

      .current{
        display: block;
        z-index: 5;
      }

      .next{
        display: block;
      }

    </style>
  </head>
  <body>
    <div id="app">
      <div class="container">
        <div class="cards">
          <div class="card div1" style="background-color:skyblue">
            Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.

          </div>
          <div class="card div2" style="background-color:pink">

          </div>
          <div class="card div3" style="background-color:yellow">

          </div>
          <div class="card div4" style="background-color:gray">
            <!-- <div class="wrapper">
              <div class="description">
                <div class="first-row">
                  <div class="title">

                  </div>
                  <ul>
                    <li>참여 수</li>
                    <li>팔로우 수</li>
                    <li>댓글</li>
                  </ul>
                </div>
                <div class="second-row">
                  <p>작가의 말</p>
                </div>
              </div>
              <div class="preview">

              </div>
            </div> -->
          </div>
        </div>
      </div>

    </div>

    <script>
    window.onload = function(){
      var cards = [].slice.call(document.querySelectorAll('.card'));

      var fromTo = (from, to, prgrs = 0) => from + (to - from) * prgrs;

      var easing = {
        inCubic: function(t, b, c, d) { // t: current time, b: begInnIng value, c: change In value, d: duration
          var ts = (t /= d) * t;
          var tc = ts * t;
          return b + c * (1.7 * tc * ts - 2.05 * ts * ts + 1.5 * tc - 0.2 * ts + 0.05 * t);
        }
      };

      var transforms = {
        translate3D: function(x = 0, y = 0, z = 0, el = "px") {
          return `translate3d(${x}${el}, ${y}${el}, ${z}${el})`;
        },

        rotate3d: function(x = 0, y = 0, z = 0, deg = 0) {
          return `rotate3d(${x}, ${y}, ${z}, ${deg}deg)`;
        },

        rotate: function(deg = 0) {
          return `rotate(${deg}deg)`;
        },

        scale: function(x = 0, y = 0) {
          return `scale(${x}, ${y})`;
        },

        perspective: function(val = 0, el = "px") {
          return `perspective(${val}${el})`;
        }
      };

      var curBlocks = {
        blocks: cards.slice(),
        index: 0,

        swapBlocks: function() {
          let shd = this.blocks.shift();
          let count = cards.length;
          if (count > this.index +4) {
            this.blocks.push(cards[this.index +5]);
            console.log('이게 실행이 되긴 해?');
          }
          else {
            this.blocks.push(shd);
            console.log('정상행위');
            console.log(this.blocks);
          }
          shd.classList.remove('current');
          this.index === count ? this.index = 0 : this.index++;
          initScene();
        }
      };

      var block = {
        width: 35,
        heigth: 30.6,
        b2scale: 32 / 35,
        upHeigth: 1,

        b2caclH: 0,

        interact: false
      };

      var initScene = function() {
        console.log('세팅카운트');
        block.b2caclH =
        block.heigth * (1 - block.b2scale) * (1 / block.b2scale) / 2
        + block.upHeigth * (1 / block.b2scale);

        curBlocks.blocks[0].style.transform = transforms.translate3D(0, 0, 0, "rem");
        curBlocks.blocks[1].style.transform =
        transforms.scale(block.b2scale, block.b2scale)
        + transforms.translate3D(0, block.b2caclH, 0, "rem");

        curBlocks.blocks[0].style.opacity = 1;
        curBlocks.blocks[1].style.opacity = 0.1;

        curBlocks.blocks[0].className = "card current";
        curBlocks.blocks[1].className = "card next";
        // bindDrag();
      };

      initScene();

      var drag = {
        degree: 2.8,
        upHeight: 1.7,
        maxDrag: 78,
        b2scale: 0.98,
        dx: 0,
        frameBusy: false,
        helloSafari: 2.8 // need to add this coz of strange behavior
      };


      var dragBlock = function() {
        const maxStep = drag.maxDrag;
        let curStep = drag.dx;
        if (curStep > maxStep) curStep = maxStep;
        if (curStep < -maxStep) curStep = -maxStep;

        let progress = curStep / maxStep;
        let curDeg = drag.degree * progress;
        let curUpLen = drag.upHeight * Math.abs(curStep) / maxStep;
        let curScaleBlock2 = drag.b2scale + (1 - drag.b2scale) * (maxStep - curStep) / maxStep;

        curBlocks.blocks[0].style.transform =
            transforms.perspective(220, "rem")
          + transforms.rotate(curDeg)
          + transforms.rotate3d(1, 1, 0, curDeg * 3)
          + transforms.translate3D(0, -curUpLen, 0, "rem");

        curBlocks.blocks[1].style.transform =
            transforms.scale(block.b2scale * curScaleBlock2, block.b2scale * curScaleBlock2)
          + transforms.translate3D(0, block.b2caclH - curUpLen / 4, 0, "rem")
          + transforms.rotate(curDeg / 3)
          + transforms.rotate3d(1, 1, 0, curDeg * drag.helloSafari);

        curBlocks.blocks[0].style.opacity = 1;
        curBlocks.blocks[1].style.opacity = fromTo(0.1, 0.7, progress);
        drag.frameBusy = false;
      };

      var throwing = {
        animating: false,
        curStep: 0,
        maxStep: 15
      };

      var throwBlock = function() {
        if (++throwing.curStep > throwing.maxStep) {
          // hammer.off("mousedown touchstart");
          throwing.curStep = 0;
          drag.dx = 0;
          curBlocks.swapBlocks();
          return;
        }
        //
        let progress = easing.inCubic(throwing.curStep, 0, 1, throwing.maxStep);
        let delta = easing.inCubic(throwing.curStep, 0, 1, throwing.maxStep) * 40;

        curBlocks.blocks[0].style.transform =
            transforms.rotate(drag.degree + delta / 2)
          + transforms.rotate3d(1, 1, 0, drag.degree * 3)
          + transforms.translate3D(delta, -drag.upHeight - delta / 1.2, 0, "rem");

        let b2Scale = fromTo(block.b2scale * drag.b2scale, 1, progress);
        let b2TransY = fromTo(block.b2caclH - drag.upHeight / 4, 0, progress);
        let b2Rot = fromTo(drag.degree / 3, 0, progress);

        curBlocks.blocks[1].style.transform =
            transforms.scale(b2Scale, b2Scale)
          + transforms.translate3D(0, b2TransY, 0, "rem")
          + transforms.rotate(b2Rot)
          + transforms.rotate3d(1, 1, 0, drag.degree * drag.helloSafari);

        curBlocks.blocks[0].style.opacity = fromTo(1, 0.5, progress);
        curBlocks.blocks[1].style.opacity = fromTo(0.7, 1, progress);

        requestAnimationFrame(throwBlock);
      };

      // function bindDrag() {
      var touchZone = document.querySelector('.cards')
      var hammer = new Hammer(touchZone);
      // hammer.on('panmove', function(e){
      //   console.log(e);
      // })
      hammer.on('panmove', function(e){
        if (e.deltaX <= 0) e.deltaX = 0;
        if (e.deltaY >= 0) e.deltaY = 0;

        drag.dx = Math.sqrt(Math.pow(e.deltaX, 2) + Math.pow(e.deltaY, 2));
        if (!drag.dx) return;
        if (drag.frameBusy) return;
        drag.frameBusy = true;
        requestAnimationFrame(dragBlock);
        console.log('pan moving');
      })
      hammer.on("panend", function (e) {
        if (Math.abs(drag.dx) < drag.maxDrag) {
          drag.dx = 0;
          requestAnimationFrame(dragBlock);
        }
        else {
          requestAnimationFrame(throwBlock);
        }
        console.log('panend');
      })
    

      // function bindDrag() {
      //   $(document).on("mousedown touchstart", ".slide1", function (e) {
      //     const startX = e.pageX || e.originalEvent.touches[0].pageX;
      //     const startY = e.pageY || e.originalEvent.touches[0].pageY;
      //     block.interact = true;
      //
      //     $(document).on("mousemove touchmove", function (e) {
      //       let curX = e.pageX || e.originalEvent.touches[0].pageX;
      //       let curY = e.pageY || e.originalEvent.touches[0].pageY;
      //
      //       if (curX - startX <= 0) curX = startX;
      //       if (curY - startY >= 0) curY = startY;
      //
      //       drag.dx = Math.sqrt(Math.pow(curX - startX, 2) + Math.pow(curY - startY, 2));
      //
      //       if (!drag.dx) return;
      //       if (drag.frameBusy) return;
      //       drag.frameBusy = true;
      //       requestAnimationFrame(dragBlock);
      //     });
      //
      //     $(document).on("mouseup touchend", function (e) {
      //       $(document).off("mousemove touchmove mouseup touchend");
      //       if (Math.abs(drag.dx) < drag.maxDrag) {
      //         drag.dx = 0;
      //         requestAnimationFrame(dragBlock);
      //       }
      //       else {
      //         descriptions.animateDescription();
      //         setTimeout(descriptions.swapDescription.bind(descriptions), descriptions.timeout);
      //         curBlocks.blocks[1].children[0].play();
      //         requestAnimationFrame(throwBlock);
      //       }
      //     });
      //   });
      // };
      //
      //
      //
      //
      //
      //
      //
      //
      //
      // function animationDone(e) {
      //   var origin = e.target;
      //   if(e.animationName === 'fadeOutLeft'){
      //     origin.classList.remove('current');
      //     origin.classList.add('previous');
      //
      //     if (!origin.nextElementSibling) {
      //       alert('더 이상 존재하는 소설이 없습니다.')
      //     }
      //     origin.nextElementSibling.classList.remove('next');
      //     origin.nextElementSibling.classList.add('current');
      //     console.log(e);
      //   }
      // }
      //
      // cards.addEventListener('animationend', animationDone);


    }()

    </script>

  </body>
</html>
